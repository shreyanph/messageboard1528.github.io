<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Message Board</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    /* PAGE BACKGROUND */
    body {
      font-family: Arial, sans-serif;
      min-height: 100vh;
      margin: 0;
      color: #ffffff;
      background-image: url("https://scx1.b-cdn.net/csz/news/800a/2023/data-science.jpg");
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;
      position: relative;
    }

    /* main page inner (center column) */
    .page-inner {
      position: relative;
      max-width: 900px;
      margin: 40px auto 160px; /* room for fixed composer */
      padding: 12px;
      box-sizing: border-box;
    }

    /* Top-left How To Use */
    #howBtn {
      position: fixed;
      top: 12px;
      left: 12px;
      z-index: 15000;
      background: rgba(255,165,0,0.95);
      border: 1px solid rgba(255,255,255,0.15);
      padding: 6px 10px;
      border-radius: 6px;
      color: #fff;
      cursor: pointer;
    }

    /* Admin manage button (next to How To Use) */
    #manageBtn {
      position: fixed;
      top: 12px;
      left: 120px;
      z-index: 15000;
      background: rgba(30,144,255,0.95);
      border: 1px solid rgba(255,255,255,0.15);
      padding: 6px 10px;
      border-radius: 6px;
      color: #fff;
      display: none;
      cursor: pointer;
    }

    /* Top-right sign out & change pw */
    #signOutBtn { position: fixed; top:12px; right:12px; z-index:15000; background: rgba(220,20,60,0.95); padding:6px 10px; border-radius:6px; border:1px solid rgba(255,255,255,0.15); color:#fff; display:none; }
    #changePwBtn { position: fixed; top:12px; right:96px; z-index:15000; background: rgba(30,144,255,0.95); padding:6px 10px; border-radius:6px; border:1px solid rgba(255,255,255,0.15); color:#fff; display:none; }

    /* messages container */
    #messages {
      margin-top: 10px;
      display:flex;
      flex-direction: column;
      gap: 10px;
      overflow: auto;
      max-height: calc(100vh - 420px);
      padding-bottom: 12px;
      box-sizing: border-box;
    }

    .message-row { display:flex; align-items:flex-start; gap:8px; position:relative; }
    .message { border-radius:999px; padding: 14px 20px; display:inline-block; max-width:100%; line-height:1.25; box-sizing:border-box; color:#fff; background: rgba(0,0,0,0.45); }
    .message .name { font-weight:700; margin-right:8px; }

    .actions { display:flex; gap:6px; align-items:center; margin-left:6px; opacity:0; transition:opacity 120ms ease; }
    .message-row:hover .actions, .message-row:focus-within .actions { opacity:1; }

    .icon-btn { width:36px; height:36px; display:inline-flex; align-items:center; justify-content:center; border-radius:6px; border:none; cursor:pointer; background: rgba(255,255,255,0.06); color:#fff; font-size:16px; padding:4px; }
    .icon-btn.trash { background: rgba(220,20,60,0.95); }
    .icon-btn.pencil { background: rgba(30,144,255,0.95); }
    .icon-btn.reply-btn { background: rgba(255,165,0,0.95); color:#fff; font-weight:700; font-size:18px; opacity:0; pointer-events:none; transition:opacity 120ms ease; }
    .message-row:hover .icon-btn.reply-btn, .message-row:focus-within .icon-btn.reply-btn { opacity:1; pointer-events:auto; }

    .timestamp-row { display:flex; align-items:center; gap:10px; margin:8px 0; font-size:0.9em; color:#fff; }
    .timestamp-row .line { flex:1; height:1px; background: rgba(255,255,255,0.18); }
    .timestamp-row .timestamp-text { padding:0 6px; white-space:nowrap; }

    /* Lock-screen overlay (login) - must be on top */
    #loginOverlay {
      position: fixed;
      left: 0; top: 0;
      width: 100vw; height: 100vh;
      display: flex; align-items: center; justify-content: center;
      z-index: 20000; /* highest */
      background: rgba(0,0,0,0.65);
    }
    .login-card {
      position: relative;
      display:flex; flex-direction:column; align-items:center; gap:18px;
      background: rgba(0,0,0,0.85);
      border:1px solid rgba(255,255,255,0.12);
      padding: 26px 28px; border-radius:12px;
      min-width:320px; min-height:460px; box-shadow: 0 20px 60px rgba(0,0,0,0.7);
      transform-origin:center center; transform: scaleY(1);
    }
    .split-top, .split-bottom { position:absolute; left:0; right:0; background: rgba(0,0,0,0.76); z-index:2500; pointer-events:none; }
    .split-top { top:0; height:50%; } .split-bottom { bottom:0; height:50%; }

    .avatar { width:112px; height:112px; border-radius:50%; background: rgba(255,255,255,0.06); display:flex; align-items:center; justify-content:center; font-size:48px; color:#fff; border:2px solid rgba(255,255,255,0.06); }
    .login-title { font-size:18px; color:#fff; }
    .account-btn { width:260px; display:flex; align-items:center; gap:12px; padding:10px 14px; border-radius:10px; background: rgba(255,255,255,0.03); border:1px solid rgba(255,255,255,0.06); color:#fff; cursor:pointer; font-size:16px; }

    #passwordArea { display:none; width:100%; gap:8px; flex-direction:column; align-items:stretch; }
    input[type="password"] { padding:8px; border-radius:4px; border:1px solid rgba(255,255,255,0.25); background:#fff; color:#000; }

    /* Management modal */
    .manage-backdrop { display:none; position: fixed; inset:0; z-index:18000; background: rgba(0,0,0,0.6); align-items:center; justify-content:center; }
    .manage-modal { width: min(920px, calc(100% - 40px)); max-height: 84vh; overflow:auto; background: rgba(0,0,0,0.95); border:1px solid rgba(255,255,255,0.12); border-radius:10px; padding:16px; color:#fff; display:flex; gap:16px; box-shadow: 0 10px 40px rgba(0,0,0,0.6); }

    .panel { background: rgba(0,0,0,0.7); border: 1px solid rgba(255,255,255,0.12); padding:12px; border-radius:8px; color:#fff; margin-bottom:12px; }
    #accountsList, #serversList { list-style:none; padding:0; margin:6px 0; max-height:320px; overflow:auto; }
    #accountsList li, #serversList li { display:flex; justify-content:space-between; gap:8px; align-items:center; padding:6px 4px; border-radius:6px; }

    .remove-account { background: rgba(220,20,60,0.95); border:none; color:#fff; padding:6px 10px; border-radius:6px; cursor:pointer; }
    .remove-account.disabled { opacity:0.45; cursor:not-allowed; background: rgba(255,255,255,0.02); }

    .change-account-pw { background: rgba(30,144,255,0.95); border: none; color: #fff; padding: 6px 10px; border-radius: 6px; cursor: pointer; font-size:14px; line-height:1.2; }

    /* Composer fixed at bottom (hidden on lock screen) */
    .composer {
      position: fixed; bottom: 12px; left: 50%; transform: translateX(-50%);
      z-index: 17000; width: min(640px, calc(100% - 32px));
      background: rgba(0,0,0,0.85); border:1px solid rgba(255,255,255,0.12); padding:10px; border-radius:10px; box-shadow:0 8px 30px rgba(0,0,0,0.6);
      display: none; flex-direction:column; gap:8px;
    }
    .composer-row { display:flex; gap:8px; align-items:center; }
    .emoji-grid { display:grid; grid-template-columns: repeat(8,1fr); gap:6px; }

    /* Side panels (DM and Servers) */
    .side-panel {
      position: fixed; top: 56px; width: 220px;
      z-index: 16000; background: rgba(0,0,0,0.85); border:1px solid rgba(255,255,255,0.12); border-radius:8px; padding:10px; box-shadow:0 8px 30px rgba(0,0,0,0.5);
      display: none; max-height: calc(100vh - 100px); overflow:auto;
    }
    .side-panel.open { display:block; }
    #dmPanel { left:12px; } #serverSelectPanel { right:12px; }
    .side-panel h4 { margin:0 0 8px 0; color:#fff; }
    .side-panel ul { list-style:none; padding:0; margin:0; }
    .side-panel li { display:flex; align-items:center; justify-content:space-between; padding:6px; border-radius:8px; margin-bottom:6px; cursor:pointer; color:#fff; }
    .side-panel li.selected { background: rgba(255,255,255,0.04); }

    @media (max-width:900px) {
      .side-panel { width: 180px; }
      .manage-modal { flex-direction: column; }
      .page-inner { margin: 20px 12px 160px; }
      .composer { width: calc(100% - 24px); }
    }
  </style>
</head>
<body>
  <!-- Lock/Sign-in overlay -->
  <div id="loginOverlay" role="dialog" aria-modal="true" aria-label="Login">
    <div class="login-card" role="presentation">
      <div class="split-top" aria-hidden="true"></div>
      <div class="split-bottom" aria-hidden="true"></div>

      <div id="avatarCircle" class="avatar" aria-hidden="true"></div>
      <div class="login-title" id="loginTitle">Select an account to sign in</div>

      <div id="accountButtons" style="display:flex; flex-direction:column; gap:8px; align-items:center; width:100%;"></div>

      <div id="passwordArea" aria-hidden="true">
        <div id="pwPromptText" style="margin-bottom:4px; color:rgba(255,255,255,0.9); font-size:0.95em;"></div>
        <div id="pwErr" style="display:none;color:rgba(255,200,200,1);font-size:0.9em;margin-bottom:4px;"></div>

        <div id="enterPw" style="display:none; gap:8px; flex-direction:column;">
          <input id="passwordInput" type="password" placeholder="Password" autocomplete="new-password" />
          <div style="display:flex; gap:8px;">
            <button id="submitPwBtn">Submit</button>
            <button id="cancelPwBtn" style="background:rgba(255,255,255,0.06); color:#fff;">Cancel</button>
          </div>
        </div>

        <div id="createPw" style="display:none; gap:8px; flex-direction:column;">
          <input id="newPasswordInput" type="password" placeholder="New password" />
          <input id="newPasswordRetype" type="password" placeholder="Retype new password" />
          <div style="display:flex; gap:8px;">
            <button id="createPwBtn">Create</button>
            <button id="cancelCreateBtn" style="background:rgba(255,255,255,0.06); color:#fff;">Cancel</button>
          </div>
        </div>
      </div>

      <div id="loginHint" style="font-size:0.85em; color:rgba(255,255,255,0.75);">
        Click/Press your account to sign in
      </div>
    </div>
  </div>

  <!-- Administration modal (Account & Server Management) -->
  <div id="manageBackdrop" class="manage-backdrop" role="dialog" aria-modal="true" style="display:none;">
    <div class="manage-modal" role="document" aria-label="Account and Server Management">
      <div style="display:flex; justify-content:flex-end; width:100%; position:relative; margin-bottom:-8px;">
        <button id="closeManage" style="position:absolute; right:8px; top:-8px; background:transparent; border:none; color:#fff; font-size:22px; cursor:pointer;">&times;</button>
      </div>
      <div style="flex:1; min-width:320px;">
        <div id="adminPanel" class="panel">
          <h4>Accounts (cloud)</h4>
          <div style="display:flex; gap:8px; margin-bottom:8px;">
            <input id="newAccountInput" placeholder="New account name" style="flex:1; padding:6px;" />
            <button id="addAccountBtn" style="padding:6px 8px;">Add</button>
          </div>
          <ul id="accountsList" aria-live="polite"></ul>
        </div>
      </div>
      <div style="flex:1; min-width:320px;">
        <div id="serversPanel" class="panel">
          <h4>Servers (cloud)</h4>
          <div style="display:flex; gap:8px; margin-bottom:8px;">
            <input id="newServerInput" placeholder="New server name" style="flex:1; padding:6px;" />
            <button id="addServerBtn" style="padding:6px 8px;">Add</button>
          </div>
          <ul id="serversList" aria-live="polite"></ul>
        </div>
      </div>
    </div>
  </div>

  <!-- Left DM panel and Right Server selection panel (hidden until login) -->
  <div id="dmPanel" class="side-panel" aria-hidden="true">
    <h4>Direct Messages</h4>
    <ul id="dmList"></ul>
  </div>

  <div id="serverSelectPanel" class="side-panel" aria-hidden="true">
    <h4>Servers</h4>
    <ul id="serverSelectList"></ul>
  </div>

  <div class="page-inner">
    <button id="howBtn">How To Use</button>
    <button id="manageBtn">Account &amp; Server Management</button>

    <div style="margin-top: 60px;">
      <div id="messages" aria-live="polite"></div>
    </div>

    <br>
    <button id="clearBtn" title="Only Administrator may clear history">Clear Message History</button>
  </div>

  <!-- Composer fixed bottom (hidden until login) -->
  <div class="composer" id="composer" role="region" aria-label="Message composer">
    <div id="replyIndicator" class="reply-indicator" aria-hidden="true" style="display:none;">
      <div id="replyIndicatorText"></div>
      <button id="cancelReplyBtn" class="cancel-reply" style="background:rgba(220,20,60,0.95); border:none; color:#fff; padding:6px 8px; border-radius:6px;">Cancel</button>
    </div>

    <div class="composer-row">
      <div class="emoji-row" id="emojiRow" style="position:relative; flex:1;">
        <textarea id="messageInput" placeholder="Type a message..."></textarea>
        <button id="emojiBtn" type="button" title="Insert emoji">ðŸ˜Š</button>
        <div id="emojiPicker" class="emoji-picker" aria-hidden="true" style="display:none; position:absolute; top: calc(100% + 8px); right:0;">
          <div class="emoji-grid" id="emojiGrid"></div>
        </div>
      </div>
    </div>

    <div class="composer-row" style="justify-content:flex-end;">
      <div style="display:flex; gap:8px;">
        <button id="sendBtn">Send</button>
        <button id="deleteCurrentBtn" title="Clear current message">Delete Current Message</button>
      </div>
    </div>
  </div>

  <button id="signOutBtn" title="Sign out">Sign Out</button>
  <button id="changePwBtn" title="Change your password">Change Password</button>

  <div id="howBackdrop" class="manage-backdrop" style="display:none;">
    <div class="manage-modal" style="width:600px; max-height:70vh; overflow:auto;">
      <div style="display:flex; justify-content:flex-end; width:100%;">
        <button id="howClose" style="background:transparent;border:none;color:#fff;font-size:22px;cursor:pointer;">&times;</button>
      </div>
      <div style="padding:8px;">
        <h3>How To Use</h3>
        <ol>
          <li><u>Administrator</u> creates accounts and servers from Account &amp; Server Management.</li>
          <li>Sign in by selecting an account from the lock screen. If password missing you'll be prompted to create one.</li>
          <li>Messages are always sent as the signed-in account. Select a user or server from the side panels to chat with them.</li>
        </ol>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
    import {
      getFirestore,
      collection,
      addDoc,
      serverTimestamp,
      query,
      orderBy,
      onSnapshot,
      setDoc,
      doc,
      deleteDoc,
      getDocs,
      getDoc,
      updateDoc
    } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDP7gvu9KT8u37wNEFJ1BUPBBxGKiIUEo8",
      authDomain: "message-history-2d3ab.firebaseapp.com",
      projectId: "message-history-2d3ab",
      storageBucket: "message-history-2d3ab.firebasestorage.app",
      messagingSenderId: "258209489466",
      appId: "1:258209489466:web:fae16998d2b8c161e6cb03",
      measurementId: "G-X3LTVS01X8"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // DOM refs
    const loginOverlay = document.getElementById('loginOverlay');
    const accountButtons = document.getElementById('accountButtons');
    const avatarCircle = document.getElementById('avatarCircle');
    const passwordArea = document.getElementById('passwordArea');
    const pwPromptText = document.getElementById('pwPromptText');
    const enterPw = document.getElementById('enterPw');
    const createPw = document.getElementById('createPw');
    const passwordInput = document.getElementById('passwordInput');
    const submitPwBtn = document.getElementById('submitPwBtn');
    const cancelPwBtn = document.getElementById('cancelPwBtn');
    const newPasswordInput = document.getElementById('newPasswordInput');
    const newPasswordRetype = document.getElementById('newPasswordRetype');
    const createPwBtn = document.getElementById('createPwBtn');
    const cancelCreateBtn = document.getElementById('cancelCreateBtn');
    const loginHint = document.getElementById('loginHint');
    const pwErr = document.getElementById('pwErr');

    const howBtn = document.getElementById('howBtn');
    const howBackdrop = document.getElementById('howBackdrop');
    const howClose = document.getElementById('howClose');

    const manageBtn = document.getElementById('manageBtn');
    const manageBackdrop = document.getElementById('manageBackdrop');
    const closeManage = document.getElementById('closeManage');

    const accountsList = document.getElementById('accountsList');
    const addAccountBtn = document.getElementById('addAccountBtn');
    const newAccountInput = document.getElementById('newAccountInput');

    const serversList = document.getElementById('serversList');
    const addServerBtn = document.getElementById('addServerBtn');
    const newServerInput = document.getElementById('newServerInput');

    const dmPanel = document.getElementById('dmPanel');
    const dmList = document.getElementById('dmList');
    const serverSelectPanel = document.getElementById('serverSelectPanel');
    const serverSelectList = document.getElementById('serverSelectList');

    const messagesDiv = document.getElementById('messages');
    const composer = document.getElementById('composer');
    const messageInput = document.getElementById('messageInput');
    const sendBtn = document.getElementById('sendBtn');
    const deleteCurrentBtn = document.getElementById('deleteCurrentBtn');
    const emojiBtn = document.getElementById('emojiBtn');
    const emojiPicker = document.getElementById('emojiPicker');
    const emojiGrid = document.getElementById('emojiGrid');
    const replyIndicator = document.getElementById('replyIndicator');
    const replyIndicatorText = document.getElementById('replyIndicatorText');
    const cancelReplyBtn = document.getElementById('cancelReplyBtn');

    const signOutBtn = document.getElementById('signOutBtn');
    const changePwBtn = document.getElementById('changePwBtn');
    const clearBtn = document.getElementById('clearBtn');

    // firebase refs
    const accountsDocRef = doc(db, 'meta', 'accounts');
    const passwordsDocRef = doc(db, 'meta', 'passwords');
    const serversDocRef = doc(db, 'meta', 'servers');
    const ADMIN_NAME = 'Administrator';

    // state
    let currentUser = null;
    let passwordFlow = { active:false, account:null, mode:null };
    let lastMessages = [];
    let accountsCache = [];
    let serversMap = {};
    let replyTargetId = null;
    let replyTargetName = null;
    let chatTarget = { type:'main', name:null };

    // helper: hashing
    async function hashPassword(password) {
      const enc = new TextEncoder();
      const data = enc.encode(password);
      const hashBuffer = await crypto.subtle.digest('SHA-256', data);
      const hashArray = Array.from(new Uint8Array(hashBuffer));
      return hashArray.map(b => b.toString(16).padStart(2,'0')).join('');
    }

    // ensure admin present
    (async function ensureAdminPresent(){
      try {
        const snap = await getDoc(accountsDocRef);
        if (!snap.exists()) {
          await setDoc(accountsDocRef, { list: [ADMIN_NAME] });
        } else {
          const data = snap.data();
          const list = Array.isArray(data?.list) ? data.list : [];
          if (!list.includes(ADMIN_NAME)) {
            const updated = [ADMIN_NAME, ...list];
            await setDoc(accountsDocRef, { list: updated }, { merge: true });
          }
        }
      } catch(e) {
        console.warn('ensureAdminPresent failed:', e?.message || e);
      }
    })();

    // realtime listeners
    onSnapshot(accountsDocRef, snap => {
      const list = (snap.exists() && Array.isArray(snap.data().list)) ? snap.data().list : [];
      populateAccountButtons(list);
      accountsCache = Array.isArray(list) ? list.slice() : [];
      if (!accountsCache.includes(ADMIN_NAME)) accountsCache.unshift(ADMIN_NAME);
      renderDMList();
      populateManageAccounts(list);
    }, err => {
      console.error('accounts listener', err);
      populateAccountButtons([]);
      accountsCache = [];
      renderDMList();
      populateManageAccounts([]);
    });

    onSnapshot(serversDocRef, snap => {
      const map = snap.exists() ? (snap.data().map || {}) : {};
      serversMap = Object.assign({}, map);
      renderServerSelectionList();
      populateManageServers(serversMap);
    }, err => {
      console.warn('servers listener', err);
      serversMap = {};
      renderServerSelectionList();
      populateManageServers({});
    });

    const messagesCol = collection(db, 'messages');
    const messagesQuery = query(messagesCol, orderBy('time','asc'));
    onSnapshot(messagesQuery, snapshot => {
      const msgs = [];
      snapshot.forEach(d => {
        const data = d.data();
        msgs.push({
          id: d.id,
          name: data.name,
          text: data.text || '',
          time: data.time || null,
          parentId: data.parentId || null,
          dmTarget: data.dmTarget || null
        });
      });
      lastMessages = msgs;
      renderMessages();
    }, err => {
      console.error('messages listener', err);
    });

    /********** Account button/login population **********/
    function populateAccountButtons(list) {
      accountButtons.innerHTML = '';
      const safe = Array.isArray(list) ? list.slice() : [];
      if (safe.length === 0) safe.push(ADMIN_NAME);
      if (!safe.includes(ADMIN_NAME)) safe.unshift(ADMIN_NAME);

      const seen = new Set();
      for (const name of safe) {
        if (!name || seen.has(name)) continue;
        seen.add(name);
        const b = document.createElement('button');
        b.className = 'account-btn';
        b.textContent = name;
        b.addEventListener('mouseenter', ()=>{ if(!passwordFlow.active) avatarCircle.textContent = name.charAt(0).toUpperCase();});
        b.addEventListener('mouseleave', ()=>{ if(!passwordFlow.active) avatarCircle.textContent = '';});
        b.addEventListener('click', ()=> startPasswordFlowFor(name));
        accountButtons.appendChild(b);
      }
    }

    async function startPasswordFlowFor(accountName) {
      passwordFlow.active = true; passwordFlow.account = accountName; passwordFlow.mode = null;
      accountButtons.style.display = 'none';
      passwordArea.style.display = 'flex';
      passwordArea.setAttribute('aria-hidden','false');
      pwPromptText.textContent = `Sign in as ${accountName}`;
      pwErr.style.display = 'none'; pwErr.textContent = '';
      avatarCircle.textContent = accountName.charAt(0).toUpperCase();

      try {
        const snap = await getDoc(passwordsDocRef);
        const map = (snap.exists() && snap.data().map) ? snap.data().map : {};
        if (map && map[accountName]) {
          passwordFlow.mode = 'enter';
          enterPw.style.display = 'flex'; createPw.style.display = 'none';
          passwordInput.value = ''; passwordInput.focus();
        } else {
          passwordFlow.mode = 'create';
          enterPw.style.display = 'none'; createPw.style.display = 'flex';
          newPasswordInput.value=''; newPasswordRetype.value=''; newPasswordInput.focus();
        }
      } catch(e){
        passwordFlow.mode = 'create';
        enterPw.style.display = 'none'; createPw.style.display = 'flex';
      }
    }

    function endPasswordFlow() {
      passwordFlow.active = false; passwordFlow.account = null; passwordFlow.mode = null;
      passwordArea.style.display = 'none';
      passwordArea.setAttribute('aria-hidden','true');
      accountButtons.style.display = 'flex';
      avatarCircle.textContent = '';
      pwPromptText.textContent = '';
      pwErr.style.display = 'none'; pwErr.textContent = '';
    }

    cancelPwBtn.addEventListener('click', endPasswordFlow);
    cancelCreateBtn.addEventListener('click', endPasswordFlow);

    createPwBtn.addEventListener('click', async ()=> {
      const p1 = (newPasswordInput.value||'').trim();
      const p2 = (newPasswordRetype.value||'').trim();
      if(!p1||!p2){ alert('Enter and retype password'); return; }
      if(p1!==p2){ alert('Passwords do not match'); return; }
      const acct = passwordFlow.account;
      try {
        const hashed = await hashPassword(p1);
        const snap = await getDoc(passwordsDocRef);
        const map = (snap.exists() && snap.data().map) ? snap.data().map : {};
        map[acct] = hashed;
        await setDoc(passwordsDocRef, { map }, { merge: true });
        finishLoginAs(acct);
      } catch(e){ alert('Failed to set password: '+(e.message||e)); }
    });

    submitPwBtn.addEventListener('click', async () => {
      const p = (passwordInput.value||'').trim();
      if(!p){ pwErr.style.display='block'; pwErr.textContent='Please enter your password'; passwordInput.focus(); return; }
      const acct = passwordFlow.account;
      try {
        const hashed = await hashPassword(p);
        const snap = await getDoc(passwordsDocRef);
        const map = (snap.exists() && snap.data().map) ? snap.data().map : {};
        const stored = map[acct] || null;
        if (!stored) { passwordFlow.mode = 'create'; enterPw.style.display='none'; createPw.style.display='flex'; return; }
        if (hashed === stored) { finishLoginAs(acct); } else { pwErr.style.display='block'; pwErr.textContent='Incorrect password'; passwordInput.focus(); return; }
      } catch(e){ alert('Failed to verify password: '+(e.message||e)); }
    });

    passwordInput.addEventListener('input', ()=> { pwErr.style.display='none'; pwErr.textContent=''; });

    /********** Login finished UI changes **********/
    function finishLoginAs(accountName) {
      currentUser = accountName;
      loginOverlay.style.display = 'none';
      // show composer and side panels
      composer.style.display = 'flex';
      dmPanel.classList.add('open'); dmPanel.setAttribute('aria-hidden','false'); dmPanel.style.display = 'block';
      serverSelectPanel.classList.add('open'); serverSelectPanel.setAttribute('aria-hidden','false'); serverSelectPanel.style.display = 'block';

      // manage button only for admin
      manageBtn.style.display = (currentUser === ADMIN_NAME) ? 'inline-block' : 'none';

      signOutBtn.style.display = 'inline-block';
      changePwBtn.style.display = 'inline-block';

      endPasswordFlow();
      renderDMList();
      renderServerSelectionList();
      renderMessages();
      updateClearButtonState();

      // scroll near bottom
      setTimeout(()=>{ try{ messagesDiv.scrollTop = messagesDiv.scrollHeight; }catch(e){} }, 200);
    }

    function signOut() {
      if (!confirm('Sign out?')) return;
      currentUser = null;
      // hide composer & panels
      composer.style.display = 'none';
      dmPanel.classList.remove('open'); dmPanel.setAttribute('aria-hidden','true'); dmPanel.style.display = 'none';
      serverSelectPanel.classList.remove('open'); serverSelectPanel.setAttribute('aria-hidden','true'); serverSelectPanel.style.display = 'none';
      manageBtn.style.display = 'none';
      signOutBtn.style.display = 'none';
      changePwBtn.style.display = 'none';

      // show login overlay
      loginOverlay.style.display = 'flex';
      // reset chat target
      chatTarget = { type:'main', name:null };
      renderMessages();
    }
    signOutBtn.addEventListener('click', signOut);

    changePwBtn.addEventListener('click', ()=> {
      if (!currentUser) { alert('No user'); return; }
      const current = prompt('Enter current password (leave blank if none):','');
      const newp = prompt('Enter new password:','');
      const newp2 = prompt('Retype new password:','');
      (async ()=> {
        if (!newp || !newp2 || newp !== newp2) { alert('New passwords do not match or empty.'); return; }
        try {
          const pwSnap = await getDoc(passwordsDocRef);
          const map = (pwSnap.exists() && pwSnap.data().map) ? pwSnap.data().map : {};
          const stored = map[currentUser] || null;
          if (stored) {
            if (!current) { alert('Please enter current password.'); return; }
            const oldHash = await hashPassword(current);
            if (oldHash !== stored) { alert('Current password incorrect.'); return; }
          }
          const newHash = await hashPassword(newp);
          map[currentUser] = newHash;
          await setDoc(passwordsDocRef, { map }, { merge: true });
          alert('Password updated.');
        } catch(e){ alert('Failed to update password: '+(e.message||e)); }
      })();
    });

    /********** DM and server panels rendering **********/
    function renderDMList() {
      dmList.innerHTML = '';
      const list = Array.isArray(accountsCache) ? accountsCache.slice() : [];
      for (const name of list) {
        if (!name) continue;
        if (currentUser && name === currentUser) continue;
        const li = document.createElement('li');
        li.dataset.name = name;
        li.textContent = name;
        li.addEventListener('click', ()=> {
          chatTarget = { type:'user', name: name };
          highlightSelections();
          renderMessages();
        });
        dmList.appendChild(li);
      }
      highlightSelections();
    }

    function renderServerSelectionList() {
      serverSelectList.innerHTML = '';
      const names = Object.keys(serversMap || {}).sort();
      for (const s of names) {
        const sd = normalizeServerData(s);
        const members = sd.members || [];
        if (currentUser !== ADMIN_NAME && !members.includes(currentUser)) continue;
        const li = document.createElement('li');
        li.dataset.name = s;
        li.textContent = s;
        li.addEventListener('click', ()=> {
          chatTarget = { type:'server', name: s };
          highlightSelections();
          renderMessages();
        });
        serverSelectList.appendChild(li);
      }
      highlightSelections();
    }

    function highlightSelections() {
      const dmItems = dmList.querySelectorAll('li');
      dmItems.forEach(li => li.classList.toggle('selected', chatTarget.type === 'user' && chatTarget.name === li.dataset.name));
      const srvItems = serverSelectList.querySelectorAll('li');
      srvItems.forEach(li => li.classList.toggle('selected', chatTarget.type === 'server' && chatTarget.name === li.dataset.name));
    }

    /********** Messages rendering **********/
    function renderMessages() {
      messagesDiv.innerHTML = '';
      if (!Array.isArray(lastMessages) || lastMessages.length === 0) return;

      let visibleMessages = [];
      if (!chatTarget || chatTarget.type === 'main') {
        visibleMessages = lastMessages.filter(m => !m.dmTarget);
      } else if (chatTarget.type === 'server') {
        const sd = normalizeServerData(chatTarget.name);
        const members = sd.members || [];
        if (!currentUser || (!members.includes(currentUser) && currentUser !== ADMIN_NAME)) { visibleMessages = []; }
        else visibleMessages = lastMessages.filter(m => m.dmTarget === chatTarget.name);
      } else if (chatTarget.type === 'user') {
        if (!currentUser) visibleMessages = [];
        else visibleMessages = lastMessages.filter(m => {
          if (!m.dmTarget) return false;
          const sentBy = (m.name || '');
          const t = m.dmTarget;
          return (t === chatTarget.name && sentBy === currentUser) || (t === currentUser && sentBy === chatTarget.name);
        });
      }

      if (visibleMessages.length === 0) return;

      const repliesByParent = {};
      const topLevel = [];
      for (const m of visibleMessages) {
        if (m.parentId) { repliesByParent[m.parentId] = repliesByParent[m.parentId] || []; repliesByParent[m.parentId].push(m); }
        else topLevel.push(m);
      }

      const topTime = formatTimestamp(topLevel[0]?.time);
      messagesDiv.appendChild(createTimestampRow(topTime));

      for (const m of topLevel) {
        const who = (m.name && String(m.name).trim()) ? String(m.name).trim() : 'Unknown';
        const text = (m.text && String(m.text)) ? m.text : '';

        const row = document.createElement('div'); row.className = 'message-row';
        const div = document.createElement('div'); div.className = 'message';
        div.style.background = colorForName(who);
        const nameSpan = document.createElement('span'); nameSpan.className = 'name'; nameSpan.textContent = who + ':';
        const contentSpan = document.createElement('span'); contentSpan.className = 'content'; contentSpan.textContent = ' ' + text;
        div.appendChild(nameSpan); div.appendChild(contentSpan);

        const replyBtn = document.createElement('button'); replyBtn.type='button'; replyBtn.className='icon-btn reply-btn'; replyBtn.title='Reply'; replyBtn.innerHTML='â†ª';
        replyBtn.addEventListener('click', (ev)=> { ev.stopPropagation(); replyTargetId = m.id; replyTargetName = who; replyIndicatorText.textContent = `Replying to ${who}`; replyIndicator.style.display = 'flex'; replyIndicator.setAttribute('aria-hidden','false'); messageInput.focus(); });

        const actions = document.createElement('div'); actions.className = 'actions';
        const canAct = (currentUser === ADMIN_NAME) || (currentUser && currentUser === who);
        if (canAct) {
          const trash = document.createElement('button'); trash.className='icon-btn trash'; trash.title='Delete message'; trash.innerHTML='ðŸ—‘';
          trash.addEventListener('click', async (ev)=> { ev.stopPropagation(); if (!confirm('Delete this message?')) return; try { await deleteDoc(doc(db, 'messages', m.id)); } catch(e){ alert('Failed to delete: '+(e.message||e)); } });
          actions.appendChild(trash);

          const edit = document.createElement('button'); edit.className='icon-btn pencil'; edit.title='Edit'; edit.innerHTML='âœ';
          edit.addEventListener('click', (ev)=> { ev.stopPropagation(); startEdit(row, div, contentSpan, m); });
          actions.appendChild(edit);
        }

        row.appendChild(div); row.appendChild(replyBtn); row.appendChild(actions);
        messagesDiv.appendChild(row);

        const replies = repliesByParent[m.id] || [];
        if (replies.length) {
          replies.sort((a,b)=> {
            const ta = a.time && a.time.toDate ? a.time.toDate().getTime() : (new Date(a.time || 0)).getTime();
            const tb = b.time && b.time.toDate ? b.time.toDate().getTime() : (new Date(b.time || 0)).getTime();
            return ta - tb;
          });
          const wrap = document.createElement('div'); wrap.className='replies-wrapper';
          for (const r of replies) {
            const el = document.createElement('div'); el.className='reply';
            const who2 = (r.name && String(r.name).trim()) ? r.name : 'Unknown';
            el.innerHTML = `<span class="r-name">${who2}:</span> ${String(r.text || '')}`;
            wrap.appendChild(el);
          }
          messagesDiv.appendChild(wrap);
        }
      }

      setTimeout(()=>{ try{ messagesDiv.scrollTop = messagesDiv.scrollHeight; }catch(e){} }, 80);
    }

    function startEdit(row, div, contentSpan, messageObj) {
      const parent = div.parentElement;
      const ed = document.createElement('div'); ed.className='edit-area';
      const ta = document.createElement('textarea'); ta.value = messageObj.text || '';
      ed.appendChild(ta);
      const save = document.createElement('button'); save.className='icon-btn'; save.textContent='Save';
      save.addEventListener('click', async (ev)=> { ev.stopPropagation(); try { await setDoc(doc(db, 'messages', messageObj.id), { name: messageObj.name, text: ta.value, time: messageObj.time, parentId: messageObj.parentId || null, dmTarget: messageObj.dmTarget || null }, { merge: true }); } catch(e){ alert('Failed to save edit: '+(e.message||e)); } });
      ed.appendChild(save);
      const cancel = document.createElement('button'); cancel.className='icon-btn cancel-btn'; cancel.textContent='Cancel';
      cancel.addEventListener('click', ()=> parent.replaceChild(div, ed));
      ed.appendChild(cancel);
      parent.replaceChild(ed, div);
    }

    /********** Composer actions **********/
    sendBtn.addEventListener('click', addMessage);
    messageInput.addEventListener('keydown', (e)=> { if (e.key==='Enter' && !e.shiftKey) { e.preventDefault(); addMessage(); } });

    deleteCurrentBtn.addEventListener('click', ()=> {
      messageInput.value = ''; replyTargetId = null; replyTargetName = null; replyIndicator.style.display='none'; replyIndicator.setAttribute('aria-hidden','true'); replyIndicatorText.textContent='';
    });

    async function addMessage() {
      if (!currentUser) { alert('Sign in first'); return; }
      const text = (messageInput.value||'').trim();
      if (!text) return;
      try {
        const payload = { name: currentUser, text, time: serverTimestamp() };
        if (replyTargetId) payload.parentId = replyTargetId;
        if (chatTarget && chatTarget.type === 'server') payload.dmTarget = chatTarget.name;
        else if (chatTarget && chatTarget.type === 'user') payload.dmTarget = chatTarget.name;
        await addDoc(collection(db, 'messages'), payload);
        messageInput.value = ''; replyTargetId = null; replyTargetName = null; replyIndicator.style.display='none';
        setTimeout(()=>{ try{ messagesDiv.scrollTop = messagesDiv.scrollHeight; }catch(e){} }, 50);
      } catch(e){ alert('Failed to send message: '+(e.message||e)); }
    }

    cancelReplyBtn.addEventListener('click', ()=> { replyTargetId = null; replyTargetName = null; replyIndicator.style.display='none'; replyIndicator.setAttribute('aria-hidden','true'); replyIndicatorText.textContent=''; });

    /********** Emoji picker **********/
    const emojis = ["ðŸ˜€","ðŸ˜ƒ","ðŸ˜„","ðŸ˜","ðŸ˜†","ðŸ˜…","ðŸ˜‚","ðŸ¤£","ðŸ˜Š","ðŸ˜‡","ðŸ™‚","ðŸ™ƒ","ðŸ˜‰","ðŸ˜Œ","ðŸ˜","ðŸ¥°","ðŸ˜˜","ðŸ˜—","ðŸ˜™","ðŸ˜š","ðŸ˜‹","ðŸ˜œ","ðŸ˜","ðŸ« ","ðŸ˜Ž","ðŸ¤“"];
    emojis.forEach(e => {
      const btn = document.createElement('button'); btn.className='emoji-btn'; btn.type='button'; btn.textContent=e;
      btn.addEventListener('click', ()=> { messageInput.value += e; emojiPicker.style.display='none'; messageInput.focus(); });
      emojiGrid.appendChild(btn);
    });
    emojiBtn.addEventListener('click', ()=> { emojiPicker.style.display = (emojiPicker.style.display === 'block') ? 'none' : 'block'; });
    document.addEventListener('click', (ev)=> { if (!document.getElementById('emojiRow').contains(ev.target)) emojiPicker.style.display='none'; });

    /********** Management modal handlers **********/
    manageBtn.addEventListener('click', ()=> {
      if (currentUser !== ADMIN_NAME) return;
      manageBackdrop.style.display = 'flex';
      manageBackdrop.setAttribute('aria-hidden','false');
    });
    closeManage.addEventListener('click', ()=> { manageBackdrop.style.display='none'; manageBackdrop.setAttribute('aria-hidden','true'); });

    howBtn.addEventListener('click', ()=> { howBackdrop.style.display = 'flex'; howBackdrop.setAttribute('aria-hidden','false'); });
    howClose.addEventListener('click', ()=> { howBackdrop.style.display = 'none'; howBackdrop.setAttribute('aria-hidden','true'); });
    howBackdrop.addEventListener('click', (ev)=> { if (ev.target === howBackdrop) howBackdrop.style.display='none'; });

    /********** Admin management: accounts & servers **********/
    addAccountBtn.addEventListener('click', async ()=> {
      const v = (newAccountInput.value||'').trim();
      if (!v) return;
      if (v === ADMIN_NAME) { alert('Administrator exists'); newAccountInput.value=''; return; }
      try {
        const snap = await getDoc(accountsDocRef);
        const existing = (snap.exists() && Array.isArray(snap.data().list)) ? snap.data().list : [];
        if (existing.includes(v)) { alert('Account exists'); return; }
        const updated = existing.includes(ADMIN_NAME) ? [...existing, v] : [ADMIN_NAME, ...existing, v];
        await setDoc(accountsDocRef, { list: updated }, { merge: true });
        newAccountInput.value = '';
      } catch(e){ alert('Failed to add account: '+(e.message||e)); }
    });

    function populateManageAccounts(list) {
      accountsList.innerHTML = '';
      const arr = Array.isArray(list) ? list.slice() : [];
      if (!arr.includes(ADMIN_NAME)) arr.unshift(ADMIN_NAME);
      for (const name of arr) {
        const li = document.createElement('li');
        const label = document.createElement('span'); label.textContent = name;
        const actions = document.createElement('div'); actions.style.display='flex'; actions.style.gap='8px';
        if (name === ADMIN_NAME) {
          const rm = document.createElement('button'); rm.className='remove-account disabled'; rm.textContent='Remove'; rm.disabled=true;
          actions.appendChild(rm);
        } else {
          const changeBtn = document.createElement('button'); changeBtn.className='change-account-pw'; changeBtn.textContent='Change Password';
          changeBtn.addEventListener('click', ()=> {
            if (currentUser !== ADMIN_NAME) { alert('Only admin'); return; }
            const newpw = prompt(`Set a new password for ${name}:`,'');
            (async ()=> {
              if (!newpw) return;
              try {
                const snap = await getDoc(passwordsDocRef);
                const map = (snap.exists() && snap.data().map) ? snap.data().map : {};
                map[name] = await hashPassword(newpw);
                await setDoc(passwordsDocRef, { map }, { merge: true });
                alert('Password set.');
              } catch(e){ alert('Failed to set pw: '+(e.message||e)); }
            })();
          });
          actions.appendChild(changeBtn);

          const rm = document.createElement('button'); rm.className='remove-account'; rm.textContent='Remove';
          rm.addEventListener('click', async ()=> {
            if (!confirm(`Remove account "${name}"?`)) return;
            try {
              const snap = await getDoc(accountsDocRef);
              const existing = (snap.exists() && Array.isArray(snap.data().list)) ? snap.data().list : [];
              const filtered = existing.filter(n => n !== name && n !== undefined && n !== null);
              if (!filtered.includes(ADMIN_NAME)) filtered.unshift(ADMIN_NAME);
              await setDoc(accountsDocRef, { list: filtered }, { merge: true });
            } catch(e){ alert('Failed to remove account: '+(e.message||e)); }
          });
          actions.appendChild(rm);
        }
        li.appendChild(label); li.appendChild(actions);
        accountsList.appendChild(li);
      }
    }

    addServerBtn.addEventListener('click', async ()=> {
      if (currentUser !== ADMIN_NAME) return alert('Only admin may add server here.');
      const name = (newServerInput.value||'').trim();
      if (!name) return;
      try {
        const snap = await getDoc(serversDocRef);
        const existing = (snap.exists() && snap.data().map) ? snap.data().map : {};
        if (existing[name]) { alert('Server exists'); return; }
        existing[name] = { members: [ADMIN_NAME], creator: ADMIN_NAME };
        await setDoc(serversDocRef, { map: existing }, { merge: true });
        newServerInput.value = '';
      } catch(e){ alert('Failed to add server: '+(e.message||e)); }
    });

    function populateManageServers(map) {
      serversList.innerHTML = '';
      const names = Object.keys(map || {}).sort();
      for (const s of names) {
        const sd = normalizeServerData(s);
        const creator = sd.creator || null;
        const li = document.createElement('li');
        const label = document.createElement('span'); label.textContent = s;
        const actions = document.createElement('div'); actions.style.display='flex'; actions.style.gap='8px';

        const editBtn = document.createElement('button'); editBtn.className = 'change-account-pw'; editBtn.textContent = 'Edit';
        editBtn.addEventListener('click', async ()=> {
          const newName = prompt('Enter new server name (leave blank to cancel):', s);
          if (!newName || newName.trim() === '' || newName === s) return;
          const newTrim = newName.trim();
          try {
            const snap = await getDoc(serversDocRef);
            const existing = (snap.exists() && snap.data().map) ? snap.data().map : {};
            if (existing[newTrim]) { alert('A server with that name already exists.'); return; }
            existing[newTrim] = existing[s];
            delete existing[s];
            await setDoc(serversDocRef, { map: existing }, { merge: true });
            try {
              const msgsSnap = await getDocs(collection(db,'messages'));
              const updates = [];
              msgsSnap.forEach(md => {
                const data = md.data();
                if (data && data.dmTarget === s) updates.push(updateDoc(doc(db,'messages', md.id), { dmTarget: newTrim }));
              });
              if (updates.length) await Promise.all(updates);
            } catch (e2) { console.warn('Failed update msgs after rename'); }
          } catch(e){ alert('Rename failed: '+(e.message||e)); }
        });
        actions.appendChild(editBtn);

        const del = document.createElement('button'); del.className='remove-account'; del.textContent='Delete';
        del.addEventListener('click', async ()=> {
          if (!confirm(`Delete server "${s}"?`)) return;
          try {
            const snap = await getDoc(serversDocRef);
            const existing = (snap.exists() && snap.data().map) ? snap.data().map : {};
            if (existing[s]) delete existing[s];
            await setDoc(serversDocRef, { map: existing }, { merge: true });
            try {
              const msgsSnap = await getDocs(collection(db,'messages'));
              const updates = [];
              msgsSnap.forEach(md => {
                const data = md.data();
                if (data && data.dmTarget === s) updates.push(updateDoc(doc(db,'messages', md.id), { dmTarget: null }));
              });
              if (updates.length) await Promise.all(updates);
            } catch (e2) { console.warn('Failed clearing dmTarget after server delete'); }
          } catch(e){ alert('Failed to delete server: '+(e.message||e)); }
        });
        actions.appendChild(del);

        li.appendChild(label); li.appendChild(actions); serversList.appendChild(li);
      }
    }

    function normalizeServerData(serverName) {
      const entry = serversMap && serversMap[serverName];
      if (!entry) return { members: [], creator: null };
      if (Array.isArray(entry)) return { members: entry.slice(), creator: null };
      if (typeof entry === 'object') {
        const members = Array.isArray(entry.members) ? entry.members.slice() : [];
        const creator = entry.creator || null;
        return { members, creator };
      }
      return { members: [], creator: null };
    }

    function updateClearButtonState() {
      if (currentUser === ADMIN_NAME) { clearBtn.style.display='inline-block'; clearBtn.disabled=false; } else { clearBtn.style.display='none'; clearBtn.disabled=true; }
    }
    clearBtn.addEventListener('click', async ()=> {
      if (currentUser !== ADMIN_NAME) { alert('Only admin'); return; }
      try {
        const snap = await getDocs(collection(db,'messages'));
        const deletes = []; snap.forEach(d => deletes.push(deleteDoc(doc(db,'messages', d.id))));
        await Promise.all(deletes);
      } catch(e){ alert('Failed to clear: '+(e.message||e)); }
    });

    /********** Init: hide composer & side panels until login overlay dismissed **********/
    // Ensure login overlay is shown initially
    loginOverlay.style.display = 'flex';
    composer.style.display = 'none';
    dmPanel.style.display = 'none';
    serverSelectPanel.style.display = 'none';
    manageBackdrop.style.display = 'none';
    howBackdrop.style.display = 'none';

    // small helpers
    function formatTimestamp(ts) { if (!ts) return ''; try { const d = ts.toDate ? ts.toDate() : new Date(ts); return d.toLocaleString(); } catch(e){ return ''; } }
    function createTimestampRow(text) { const r=document.createElement('div'); r.className='timestamp-row'; const l=document.createElement('div'); l.className='line'; const t=document.createElement('div'); t.className='timestamp-text'; t.textContent = text||''; const r2=document.createElement('div'); r2.className='line'; r.appendChild(l); r.appendChild(t); r.appendChild(r2); return r; }
    const colors = ['rgba(0,180,0,0.85)','rgba(255,165,0,0.95)','rgba(220,20,60,0.95)','rgba(128,0,128,0.95)','rgba(255,0,255,0.95)'];
    function hashStringToIndex(s,mod){ let h=5381; for(let i=0;i<s.length;i++){ h=((h<<5)+h)+s.charCodeAt(i); h=h&0xffffffff; } return Math.abs(h)%mod; }
    function colorForName(name){ return colors[hashStringToIndex((name||'').toLowerCase(), colors.length)]; }

    // expose highlightSelections for use after accounts/servers updates
    function highlightSelections() {
      const dmItems = dmList.querySelectorAll('li');
      dmItems.forEach(li => li.classList.toggle('selected', chatTarget.type==='user' && chatTarget.name===li.dataset.name));
      const srvItems = serverSelectList.querySelectorAll('li');
      srvItems.forEach(li => li.classList.toggle('selected', chatTarget.type==='server' && chatTarget.name===li.dataset.name));
    }

    // initial render calls (snapshots will update)
    renderDMList();
    renderServerSelectionList();

  </script>
</body>
</html>
